WITH FilteredSales AS (
    SELECT 
        s.order_id,
        s.product_id,
        p.category_id,
        r.region_id,
        s.order_date,
        CAST(s.quantity * s.price AS DECIMAL(10,2)) AS revenue
    FROM sales s
    JOIN products p ON s.product_id = p.product_id
    JOIN regions r ON s.region_id = r.region_id
    WHERE s.order_date >= ADD_MONTHS(CAST(CURRENT_TIMESTAMP AS DATE), -12);
),
CategoryRevenue AS (
    SELECT 
        f.region_id,
        f.category_id,
        SUM(f.revenue) AS total_revenue,
        AVG(f.revenue) AS avg_order_value
    FROM FilteredSales f
    GROUP BY f.region_id, f.category_id
),
RankedCategories AS (
    SELECT 
        cr.region_id,
        cr.category_id,
        cr.total_revenue,
        cr.avg_order_value,
        RANK() OVER (PARTITION BY cr.region_id ORDER BY cr.total_revenue DESC) AS category_rank
    FROM CategoryRevenue cr
    WINDOW w AS (PARTITION BY cr.region_id ORDER BY cr.total_revenue DESC) 
)
SELECT 
    rc.region_id,
    rc.category_id,
    rc.total_revenue,
    rc.avg_order_value,
    rc.category_rank
FROM RankedCategories rc
WHERE rc.category_rank <= 3
ORDER BY rc.region_id, rc.category_rank;

 